### 多语言博客系统 开发方案

> 目标：在现有 Laravel+LPadmin 基础上，构建“多语言博客系统”，前端采用 Blade SSR，无需 Node 与独立 API；默认简体中文，以语言路径区分；提供文章、分类、标签、评论、点赞、收藏等功能，并具备完善的 SEO 与后台管理能力。

---

## 1. 需求与范围

- 基础功能
  - 文章：发布/下线、封面、摘要、正文、SEO 字段、多语言翻译
  - 分类：层级、排序、可见、多语言翻译
  - 标签：多语言翻译，文章多对多
  - 评论：前台用户可评论（审核后展示），支持楼层/引用
  - 点赞/收藏：登录用户可点赞/收藏，幂等与速率限制
  - 搜索：标题/摘要/内容关键字搜索（简单 MySQL LIKE，后续可扩展 Scout）
- 前台特性
  - 默认语言 zh，采用 `/{lang}/...` 语言前缀
  - 页面：首页、文章列表、分类、标签、详情、搜索、登录/注册/资料
  - 风格：简洁大气、轻量动效、图片懒加载
  - SEO：符合 Google/Baidu/Bing，含 canonical、hreflang、JSON‑LD、OG/Twitter
- 后台特性（LPadmin）
  - 博客管理：文章/分类/标签/评论，多语言翻译维护
  - SEO/站点设置：站点名、默认描述、OG、站点验证、sitemap
  - 权限：按菜单与操作拆分；常见角色 blog_admin/blog_editor/blog_reviewer

非目标（当前版本不做）
- 前台用户发文、私信、消息中心、富交互编辑器定制（仅后台保留）
- 外部搜索接入（如 ES）；后续作为性能增强选项

---

## 2. 架构与技术选型

- 后端：Laravel 10+、Blade SSR、MySQL、Redis（可选）
- 管理后台：沿用 LPadmin（PearAdminLayui 静态资源）
- 国际化：以路由前缀设定语言，中间件 `SetLocaleFromPath` 调整 `App::setLocale`
- 无独立前端与 API：控制器直接渲染 Blade；交互表单走传统 POST

目录与模块分层（关键）
- Controllers：`App/Http/Controllers/Blog/*`
- Models：`App/Models/Blog/*`（含 Translation）
- Services：`App/Services/Blog/*`（作者、分类树、SEO 组装、搜索等）
- Repositories（可选）：抽象查询与组合
- Middleware：`SetLocaleFromPath`、`ThrottleInteractions`
- Views：`resources/views/blog/*`
- LPadmin：控制器、视图、请求、策略在 `App/Http/Controllers/LPadmin/Blog/*` 与 `resources/views/lpadmin/blog/*`

---

## 3. 数据模型设计（JSON 多语言）

多语言字段统一使用 JSON 存储，键为语言代码（来源于后台系统配置 `lang` 列表，例如 `zh`、`en`）。不再创建 `*_translations` 表。

- posts
  - id, author_id, status[draft/published/offline], cover, published_at, meta_json, timestamps
  - 多语言字段（JSON）：
    - title_i18n, slug_i18n, summary_i18n, content_i18n, meta_title_i18n, meta_desc_i18n
- categories
  - id, parent_id, sort, visible, timestamps
  - 多语言字段（JSON）：name_i18n, slug_i18n, description_i18n
- tags
  - id, timestamps
  - 多语言字段（JSON）：name_i18n, slug_i18n
- post_tag
  - post_id, tag_id（复合唯一）
- comments
  - id, post_id, user_id, parent_id, content, status[pending/approved/blocked], ip, ua, timestamps
- likes
  - id, post_id, user_id, created_at（唯一：post_id+user_id）
- favorites
  - id, post_id, user_id, created_at（唯一：post_id+user_id）
- users（扩展）
  - nickname, avatar（资料页使用）

约束与索引
- JSON 唯一性（如 slug_i18n->zh）由应用层校验；必要时可通过生成“索引表/物化列”策略为主语言维度建立唯一索引
- posts(published_at) 索引；comments(post_id) 索引；常用列表字段建立索引

---

## 4. 路由与国际化

- 语言列表：来源后台系统配置中的 `lang` 设置（如 `['zh','en','ja']`），运行时加载
- 前台路由（示例）
  - `/{lang}/`：HomeController@index
  - `/{lang}/posts`：PostController@index（分页）
  - `/{lang}/c/{slug}`：CategoryController@show（分页）
  - `/{lang}/t/{slug}`：TagController@show（分页）
  - `/{lang}/p/{slug}`：PostController@show
  - `/{lang}/search`：SearchController@index
  - `/{lang}/auth/login|register|profile`：AuthController
- 中间件：`SetLocaleFromPath` 从 `lang` 设置 locale，非法语言回退 zh

---

## 5. 控制器与服务职责

- HomeController：精选/最新列表、站点信息
- PostController：文章列表/详情，SEO 数据组装
- CategoryController/TagController：按 slug 展示列表、SEO 数据
- SearchController：关键词搜索（标题/摘要/内容）
- CommentController：提交/展示，频率限制与审核流程
- InteractionController：点赞/收藏的创建/撤销（POST），幂等/防刷
- Services：
  - SeoService：根据实体/页面类型与 JSON 多语言字段生成 title/description/canonical/hreflang/JSON‑LD/OG
  - BlogQueryService：统一查询（含当前语言的 JSON 提取、分页）
  - I18nService：提供从 JSON 取值、回退主语言、批量构造 hreflang 的工具

---

## 6. 视图与主题（Blade）

- 布局：`blog/layouts/main.blade.php`
  - 头部 `<head>`：SEO 标签统一渲染（可注入 `@section('seo')`）
  - 页眉：导航、语言切换、搜索框
  - 页脚：版权、社交链接、sitemap 链接
- 页面
  - 首页：精选/最新文章卡片、分类导航
  - 列表页：文章卡片、分页、面包屑
  - 分类/标签页：页头简介+列表+分页
  - 详情页：正文、目录（可选）、前后文、评论区、点赞/收藏
  - 搜索页：搜索表单、结果列表
- 组件：文章卡片、评论列表/表单、面包屑、分页、语言切换、社交分享
- 动效：CSS 过渡、IntersectionObserver 懒加载；避免大依赖

---

## 7. SEO 策略（页面规范）

遵循文档《开发规范》中的“附录A：前台页面 SEO 规范”。
实现要点：
- 控制器组装 `seo.*` 数据（title/description/canonical/hreflang/jsonld/meta）
- Blade 统一输出 `<title>`、`meta description`、`link rel=canonical`、`link rel=alternate hreflang=*`、JSON‑LD、OG/Twitter
- 列表/分页 prev/next 链接；分类/标签/详情使用 JSON 多语言字段构造 hreflang（按后台语言列表）
- 站点级：sitemap、robots.txt、站点验证（Baidu/Google/Bing）

---

## 8. 后台（LPadmin）设计

- 菜单
  - 博客管理：文章、分类、标签、评论、翻译、SEO与站点设置、搜索与索引
- 权限
  - 按菜单与动作拆分 Rule；角色示例：blog_admin、blog_editor、blog_reviewer
- 多语言编辑
  - 后台编辑表单采用 Tab 方式呈现各语言字段（参考 `lpadmin/config/system/settings` 的多语言编辑交互）
  - 控件与字段：每个需要多语言的字段使用同名 `*_i18n[lang]` 提交，后端合并为 JSON
- 流程
  - 文章：创建主记录→在多语言 Tab 中维护 title/slug/summary/content/meta→发布/下线
  - 分类/标签：在多语言 Tab 中维护 name/slug/description；slug 影响 URL
  - 评论：待审→通过/屏蔽；批量操作
  - 站点与 SEO：站点名、描述、OG、验证、sitemap 生成配置
- 变更联动
  - 内容变更后：清理对应缓存；触发 sitemap 增量更新

---

## 9. 安全与合规

- 表单：CSRF 保护、服务端校验（FormRequest）
- XSS：输出转义；若开启 Markdown 渲染，采用白名单过滤
- 速率限制：
  - 评论/点赞/收藏 接口使用 Throttle；点赞/收藏再加唯一键幂等
- 审计：保留关键操作日志（后台变更、评论审核）

---

## 10. 性能与缓存

- 缓存对象：
  - 首页精选/最新、分类/标签列表（分页片段）、详情渲染片段
  - 键名包含语言（如：`blog:zh:home:latest`）
- 失效策略：
  - 内容发布/下线/更新 → 精准清理关联键
  - 定期重建热门与 sitemap
- 静态资源：合理缓存头；封面图生成多尺寸（可选）

---

## 11. 日志与监控

- 访问、错误日志按环境分级；关键操作打点（PV/UV 可后续接入）
- 告警：错误速率、评论异常激增、数据库慢查询（可选）

---

## 12. 测试计划

- 单元测试：模型关系、翻译回退、slug 唯一、服务层 SEO 生成
- 功能测试：
  - 路由与本地化：`/{lang}` 切换，fallback 行为
  - 列表/详情：分页、分类/标签过滤
  - 评论/点赞/收藏：权限、频率、幂等
  - 后台：文章/分类/标签的 CRUD 与翻译维护、评论审核
- 浏览/验收：SEO 标签、hreflang、canonical、JSON‑LD 校验（结构化数据测试工具）

---

## 13. 交付与发布

- 交付物：代码与迁移、Blade 模板、LPadmin 菜单与权限、配置与文档、示例数据
- 部署：与现有 Laravel 流程一致；执行迁移与数据填充；根据环境生成 sitemap
- 回滚：基于迁移回滚与缓存清理；配置项保守变更

---

## 14. 里程碑与工期预估（先后台，后前台）

- M1（2 天）：数据模型与迁移（JSON 多语言）
  - 建表：posts/categories/tags/post_tag/comments/likes/favorites/users 扩展
  - 多语言 JSON 字段：`*_i18n`；校验与物化列策略说明
  - 基础 Seeder：示例数据（含多语言）

- M2（3-4 天）：后台 LPadmin 管理功能
  - 菜单与权限：博客管理（文章/分类/标签/评论/SEO设置）
  - CRUD：文章/分类/标签 Tab 多语言编辑、slug 校验、发布/下线
  - 评论：审核/屏蔽/批量操作；基础关键词策略
  - 站点与 SEO 设置：站点名、默认描述、OG、搜索引擎验证、sitemap 配置

- M3（1-2 天）：国际化与配置联动
  - 后台 `lang` 配置驱动语言白名单；前台中间件 `SetLocaleFromPath`
  - I18nService：JSON 取值与回退；hreflang 生成
  - 缓存键按语言区分

- M4（3-4 天）：前台页面（Blade SSR）
  - 首页/列表/分类/标签/详情/搜索页
  - SEO 输出：title/description/canonical/hreflang/JSON‑LD/OG/Twitter
  - 导航/语言切换/分页/面包屑与主题样式

- M5（2-3 天）：互动功能与权限
  - 评论提交（频率限制、CSRF、审核流程）
  - 点赞/收藏（唯一键幂等、速率限制、按钮状态）
  - 用户注册/登录/资料最小实现

- M6（2-3 天）：缓存与验收
  - 页面与片段缓存、热门与列表缓存、缓存清理钩子
  - sitemap 生成与 robots.txt、结构化数据校验
  - 测试用例与回归清单、最终验收

---

## 15. 风险与应对

- 多语言 slug 冲突：统一在翻译表层面唯一校验；提供自动去重与手动覆写
- SEO 细节缺失：通过 SeoService 集中生成，形成统一约束；增加验收清单
- 评论滥用：频率限制、内容审核、敏感词（可配置），必要时接入验证码
- 性能：高并发下采用缓存+只读片段；后续可扩展 Scout/ES

---

## 16. 验收标准（摘要）

- 页面：多语言切换稳定，列表/详情功能完备，动效轻量流畅
- SEO：各页面具备符合规范的 `<head>` 标签、canonical、hreflang、JSON‑LD；结构化数据校验通过
- 互动：评论可用（审核流程）；点赞/收藏幂等、限流有效
- 后台：可完整维护多语言内容与 SEO 字段，评论审核可用
- 文档：安装/配置/SEO 说明、数据字典、回归清单齐备


