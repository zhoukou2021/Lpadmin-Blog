### LPadmin 开发规范

> 适用范围：本项目所有 PHP 后端（Laravel 10+）、前端构建（Blade）、管理后台（PearAdminLayui）相关代码与文档。

---

## 一、项目概览与目录结构

- 后端框架：Laravel 10+（PHP >= 8.1）
- 前端构建：blade模板，静态资源位于 `public/static`
- 管理后台：LPadmin（路由前缀默认 `lpadmin`）
- 主要目录：
  - `app/`：业务代码（Controller、Service、Model、Middleware、Provider、Traits、Helpers）
  - `config/`：配置文件（含 `lpadmin.php`）
  - `routes/`：路由（`web.php`、`lpadmin.php` 等）
  - `resources/views/`：Blade 视图（`lpadmin/*` 为后台界面）
  - `public/static/`：静态资源（PearAdminLayui 等）
  - `database/`：迁移、工厂与数据填充
  - `tests/`：测试（含组件级脚本示例）
  - `docs/`：文档

建议在 IDE 中为 `app/Helpers/functions.php` 启用全局函数提示；Composer 自动加载已包含该文件。

---

## 二、架构与模块边界

- 控制器（Controller）：仅处理 HTTP 层逻辑（请求验证、资源组织、调用服务、返回响应）。
- 服务（Service）：承载业务规则与流程编排，避免将业务堆叠在控制器与模型中。
- 模型（Model）：领域数据与关系映射，不承载跨用例的流程逻辑。
- 中间件（Middleware）：鉴权、权限、日志、格式化等横切关注点（参见 `app/Http/Kernel.php` 中别名）。
- 提供者（ServiceProvider）：装配配置、容器绑定、Blade 指令、共享视图数据等（如 `LPadminServiceProvider`）。

权限系统：基于 RBAC，使用 `App\Services\LPadmin\PermissionService` 并在 Blade 中以 `@lpadmin_can`、`@lpadmin_super`、`@lpadmin_role` 指令进行视图级控制。

菜单与权限数据来源：`App\Models\LPadmin\Rule`；菜单树构建与缓存参见 `App\Services\MenuCacheService`。

---

## 三、编码规范（PHP / Laravel）

- 统一遵循 PSR-12；使用 Laravel Pint 做静态风格检查与格式化：
  - 手动执行：`vendor/bin/pint`（或在 CI 中执行）
- 严格类型与显式声明：
  - 文件顶部 `declare(strict_types=1);`（新增文件建议开启）
  - 方法签名尽量完整标注参数与返回类型
- 命名规范：
  - 类名：`PascalCase`（如 `MenuCacheService`、`RuleController`）
  - 方法/函数：`camelCase`，动词开头（如 `buildMenuTree`、`toggleStatus`）
  - 变量名：具备业务语义的名词/短语（避免 1-2 字母）
  - 常量：`UPPER_SNAKE_CASE`
- 控制流：
  - 优先使用早返回（guard clauses），避免深层嵌套
  - 仅在需要时使用 try/catch，并进行有意义的处理/记录
- 目录归属：
  - 控制器：`app/Http/Controllers/*`
  - 中间件：`app/Http/Middleware/*`
  - 服务：`app/Services/*`
  - Trait：`app/Traits/*`
  - Helper：`app/Helpers/*`（全局函数或小型工具类）
- 视图与 Blade：
  - 视图分组使用命名空间：`view('lpadmin.xxx')`
  - 权限指令：`@lpadmin_can('rule-name') ... @endlpadmin_can`

---

## 四、请求验证与响应规范

- 参数验证：
  - 优先使用 FormRequest（推荐）或在控制器中 `validate()`
  - 返回明确的错误信息与 4xx 状态码
- 响应：
  - 页面：返回 Blade 视图并通过 `View::composer` 或控制器传递数据
  - API：返回 JSON，结构建议：`{ code, message, data }`
  - 时间格式：复用中间件 `format.time` 或使用 `App\Traits\TimeFormattable`

---

## 五、路由规范

- 后台路由集中在 `routes/lpadmin.php`：
  - 路由组配置来自 `config('lpadmin.route')`（包含前缀、域名、名称前缀）
  - 公共路由：登录、验证码等不需要 `lpadmin.auth`
  - 受保护路由：统一挂载 `lpadmin.auth` 与必要的格式化/日志中间件
- 命名规范：
  - 统一 `as` 前缀（如 `lpadmin.`），功能再细分（如 `lpadmin.menu.index`）
  - 资源路由使用 `Route::resource('/', XController::class)->parameters(['' => 'x'])`

---

## 六、配置与环境

- 配置集中于 `config/`；LPadmin 专属配置在 `config/lpadmin.php`
- `.env` 控制路由、系统信息、联系方式等（见 `lpadmin.php` 中 `env(...)`）
- 服务提供者负责合并/发布配置、视图、静态资源：`LPadminServiceProvider`

环境变量示例：

```env
LPADMIN_ROUTE_PREFIX=lpadmin
LPADMIN_ROUTE_NAME=lpadmin.
LPADMIN_DOMAIN=
LPADMIN_SYSTEM_NAME=LPadmin管理系统
```

---

## 七、数据库规范（含多语言 JSON）

- 表命名：使用 `lp_` 前缀（如 `lp_admins`、`lp_roles`、`lp_rules` 等）
- 迁移：一律通过迁移文件维护结构变更，禁止手工改表
- 多语言存储：需要翻译的字段使用 JSON 存储，键为后台配置的语言代码（如 `title_i18n->zh`）
- 唯一性约束：JSON 字段的语言维度唯一性（如 slug_i18n 某语言）由应用层保证；必要时可引入物化列或索引表
- Seeder：编写最小可运行数据（如 SimplifiedPermissionSeeder）
- 外键与索引：
  - 外键命名：`fk_{from}_{to}`；索引命名：`idx_{table}_{cols}`
  - 大表字段新增前评估锁表风险与回滚策略

---

## 八、权限与菜单

- 使用 `Rule` 模型管理权限/菜单树；`type` 区分目录/菜单
- 菜单树生成：
  - 优先复用 `MenuCacheService::getMenuTree()` 或 `getUserMenus($userId)`
  - 变更后调用 `MenuCacheService::handleMenuChanged()` 清理缓存
- 视图权限：
  - `@lpadmin_can('permission')` 控制按钮/链接
  - 超管判断：`@lpadmin_super`；角色判断：`@lpadmin_role('role-name')`

---

## 九、缓存与性能

- 缓存：统一使用 `Cache::remember`，设置合理过期时间（如菜单 60 分钟）
- 批量清理：
  - 菜单缓存提供通配清理（Redis Store 下使用 `keys` 再 `del`）
- 慎用 `Cache::rememberForever`，需有失效策略

---

## 十、日志与异常处理

- 使用 Laravel 日志通道，按级别输出；生产环境降噪
- 异常：
  - 控制器层仅捕获可恢复异常；其余交由全局异常处理器 `app/Exceptions/Handler.php`
  - 不吞异常；记录上下文（userId、route、payload 摘要）

---

## 十一、前端与静态资源

- 构建：使用blade模板方式编写前端页面
- 静态资源：放置于 `public/static`，后台 UI 来自 PearAdminLayui
- 资源版本：通过构建产物或 URL 版本参数控制缓存

---

## 十二、常用命令

```bash
# 代码风格
vendor/bin/pint

# 数据库迁移与填充
php artisan migrate
php artisan migrate --seed

# 测试
vendor/bin/phpunit

# 资源构建
npm run dev
npm run build
```

---

