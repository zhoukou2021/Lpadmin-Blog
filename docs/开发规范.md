### LPadmin 开发规范

> 适用范围：本项目所有 PHP 后端（Laravel 10+）、前端构建（Vite）、管理后台（PearAdminLayui）相关代码与文档。

---

## 一、项目概览与目录结构

- 后端框架：Laravel 10+（PHP >= 8.1）
- 前端构建：Vite，静态资源位于 `public/static`
- 管理后台：LPadmin（路由前缀默认 `lpadmin`）
- 主要目录：
  - `app/`：业务代码（Controller、Service、Model、Middleware、Provider、Traits、Helpers）
  - `config/`：配置文件（含 `lpadmin.php`）
  - `routes/`：路由（`web.php`、`lpadmin.php` 等）
  - `resources/views/`：Blade 视图（`lpadmin/*` 为后台界面）
  - `public/static/`：静态资源（PearAdminLayui 等）
  - `database/`：迁移、工厂与数据填充
  - `tests/`：测试（含组件级脚本示例）
  - `docs/`：文档

建议在 IDE 中为 `app/Helpers/functions.php` 启用全局函数提示；Composer 自动加载已包含该文件。

---

## 二、架构与模块边界

- 控制器（Controller）：仅处理 HTTP 层逻辑（请求验证、资源组织、调用服务、返回响应）。
- 服务（Service）：承载业务规则与流程编排，避免将业务堆叠在控制器与模型中。
- 模型（Model）：领域数据与关系映射，不承载跨用例的流程逻辑。
- 中间件（Middleware）：鉴权、权限、日志、格式化等横切关注点（参见 `app/Http/Kernel.php` 中别名）。
- 提供者（ServiceProvider）：装配配置、容器绑定、Blade 指令、共享视图数据等（如 `LPadminServiceProvider`）。

权限系统：基于 RBAC，使用 `App\Services\LPadmin\PermissionService` 并在 Blade 中以 `@lpadmin_can`、`@lpadmin_super`、`@lpadmin_role` 指令进行视图级控制。

菜单与权限数据来源：`App\Models\LPadmin\Rule`；菜单树构建与缓存参见 `App\Services\MenuCacheService`。

---

## 三、编码规范（PHP / Laravel）

- 统一遵循 PSR-12；使用 Laravel Pint 做静态风格检查与格式化：
  - 手动执行：`vendor/bin/pint`（或在 CI 中执行）
- 严格类型与显式声明：
  - 文件顶部 `declare(strict_types=1);`（新增文件建议开启）
  - 方法签名尽量完整标注参数与返回类型
- 命名规范：
  - 类名：`PascalCase`（如 `MenuCacheService`、`RuleController`）
  - 方法/函数：`camelCase`，动词开头（如 `buildMenuTree`、`toggleStatus`）
  - 变量名：具备业务语义的名词/短语（避免 1-2 字母）
  - 常量：`UPPER_SNAKE_CASE`
- 控制流：
  - 优先使用早返回（guard clauses），避免深层嵌套
  - 仅在需要时使用 try/catch，并进行有意义的处理/记录
- 目录归属：
  - 控制器：`app/Http/Controllers/*`
  - 中间件：`app/Http/Middleware/*`
  - 服务：`app/Services/*`
  - Trait：`app/Traits/*`
  - Helper：`app/Helpers/*`（全局函数或小型工具类）
- 视图与 Blade：
  - 视图分组使用命名空间：`view('lpadmin.xxx')`
  - 权限指令：`@lpadmin_can('rule-name') ... @endlpadmin_can`

---

## 四、请求验证与响应规范

- 参数验证：
  - 优先使用 FormRequest（推荐）或在控制器中 `validate()`
  - 返回明确的错误信息与 4xx 状态码
- 响应：
  - 页面：返回 Blade 视图并通过 `View::composer` 或控制器传递数据
  - API：返回 JSON，结构建议：`{ code, message, data }`
  - 时间格式：复用中间件 `format.time` 或使用 `App\Traits\TimeFormattable`

---

## 五、路由规范

- 后台路由集中在 `routes/lpadmin.php`：
  - 路由组配置来自 `config('lpadmin.route')`（包含前缀、域名、名称前缀）
  - 公共路由：登录、验证码等不需要 `lpadmin.auth`
  - 受保护路由：统一挂载 `lpadmin.auth` 与必要的格式化/日志中间件
- 命名规范：
  - 统一 `as` 前缀（如 `lpadmin.`），功能再细分（如 `lpadmin.menu.index`）
  - 资源路由使用 `Route::resource('/', XController::class)->parameters(['' => 'x'])`

---

## 六、配置与环境

- 配置集中于 `config/`；LPadmin 专属配置在 `config/lpadmin.php`
- `.env` 控制路由、系统信息、联系方式等（见 `lpadmin.php` 中 `env(...)`）
- 服务提供者负责合并/发布配置、视图、静态资源：`LPadminServiceProvider`

环境变量示例：

```env
LPADMIN_ROUTE_PREFIX=lpadmin
LPADMIN_ROUTE_NAME=lpadmin.
LPADMIN_DOMAIN=
LPADMIN_SYSTEM_NAME=LPadmin管理系统
```

---

## 七、数据库规范（含多语言 JSON）

- 表命名：使用 `lp_` 前缀（如 `lp_admins`、`lp_roles`、`lp_rules` 等）
- 迁移：一律通过迁移文件维护结构变更，禁止手工改表
- 多语言存储：需要翻译的字段使用 JSON 存储，键为后台配置的语言代码（如 `title_i18n->zh`）
- 唯一性约束：JSON 字段的语言维度唯一性（如 slug_i18n 某语言）由应用层保证；必要时可引入物化列或索引表
- Seeder：编写最小可运行数据（如 SimplifiedPermissionSeeder）
- 外键与索引：
  - 外键命名：`fk_{from}_{to}`；索引命名：`idx_{table}_{cols}`
  - 大表字段新增前评估锁表风险与回滚策略

---

## 八、权限与菜单

- 使用 `Rule` 模型管理权限/菜单树；`type` 区分目录/菜单
- 菜单树生成：
  - 优先复用 `MenuCacheService::getMenuTree()` 或 `getUserMenus($userId)`
  - 变更后调用 `MenuCacheService::handleMenuChanged()` 清理缓存
- 视图权限：
  - `@lpadmin_can('permission')` 控制按钮/链接
  - 超管判断：`@lpadmin_super`；角色判断：`@lpadmin_role('role-name')`

---

## 九、缓存与性能

- 缓存：统一使用 `Cache::remember`，设置合理过期时间（如菜单 60 分钟）
- 批量清理：
  - 菜单缓存提供通配清理（Redis Store 下使用 `keys` 再 `del`）
- 慎用 `Cache::rememberForever`，需有失效策略

---

## 十、日志与异常处理

- 使用 Laravel 日志通道，按级别输出；生产环境降噪
- 异常：
  - 控制器层仅捕获可恢复异常；其余交由全局异常处理器 `app/Exceptions/Handler.php`
  - 不吞异常；记录上下文（userId、route、payload 摘要）

---

## 十一、前端与静态资源

- 构建：Vite（见 `vite.config.js` 与 `package.json`）
- 静态资源：放置于 `public/static`，后台 UI 来自 PearAdminLayui
- 资源版本：通过构建产物或 URL 版本参数控制缓存

---

## 附录A：前台页面 SEO 规范（首页/列表/分类/标签/详情）

适配搜索引擎：Google、Bing、Baidu。所有页面均需：`<title>`、`<meta name="description">`、`<meta name="robots">`、`canonical`、`hreflang`、结构化数据（如适用）。语言路径：使用 `/{lang}/...`，默认 `zh`。

- 通用要求
  - 标题：不超过 60-65 字符；品牌名称置于末尾，用分隔符 `-`。
  - 描述：80-160 字符，含核心关键词，自然语言；避免堆砌。
  - 关键词：可选；不强依赖 `<meta keywords>`。
  - canonical：避免重复抓取；分页页码>1 单独 canonical 到对应页；第1页 canonical 指向无 `?page=1`。
  - hreflang：为同一内容的多语言/地区版本提供互链，包含 `x-default`。
  - 结构化数据：JSON-LD，建议放置于 `<head>`。
  - Robots：默认 `index,follow`；无内容页或草稿/私有为 `noindex,follow`（仍允许跟随链接）。
  - Open Graph/Twitter：增强社交分享摘要。
  - Sitemap/Robots：`/sitemap.xml`、`/robots.txt` 按语言生成与声明。

- 首页 `/{lang}/`
  - title：`{站点名} - {一句话定位}`
  - description：`{站点简介/领域覆盖/更新频率}`
  - canonical：`/{lang}/`
  - hreflang：列出可用语言版本与 `x-default`
  - 结构化数据：`WebSite` + `BreadcrumbList(home)`；可加 `SearchAction` 站内搜索能力
  - OG/Twitter：`og:type=website`，封面图尺寸 ≥1200x630

- 博客列表 `/{lang}/posts`（含分页）
  - title：`博客文章 - 第{N}页 - {站点名}`（第1页为 `博客文章 - {站点名}`）
  - description：列表摘要+核心分类/标签
  - canonical：第1页 `/{lang}/posts`；其余 `/{lang}/posts?page=N`
  - rel prev/next：分页串联（除首页/末页）
  - 结构化数据：`BreadcrumbList`、可选 `CollectionPage`

- 分类页 `/{lang}/c/{slug}`（含分页）
  - title：`{分类名} - 第{N}页 - {站点名}`（第1页不含页码）
  - description：分类简介（来自翻译表）
  - canonical：同列表规则
  - 结构化数据：`BreadcrumbList`（Home > 分类 > {分类名}）
  - hreflang：同一分类不同语言 slug 互链

- 标签页 `/{lang}/t/{slug}`（含分页）
  - title：`#{标签名} 标签 - 第{N}页 - {站点名}`
  - description：标签简介或自动生成描述
  - canonical/prev/next：同分类规则
  - 结构化数据：`BreadcrumbList`

- 文章详情 `/{lang}/p/{slug}`
  - title：`{文章标题} - {站点名}`
  - description：文章摘要（优先显式 SEO 摘要，次选首段纯文本截断 120-160 字）
  - canonical：唯一详情地址
  - 结构化数据：`Article` 或 `BlogPosting`
    - 必填：`headline`、`datePublished`、`dateModified`、`author`、`image`（如有）、`inLanguage`
    - 可选：`publisher`（含 logo）、`articleSection`（分类）、`keywords`（标签）
  - OG/Twitter：`og:type=article`；包含 `og:title`、`og:description`、`og:image`、`article:published_time`、`article:tag`
  - 评论分页：分页 canonical 指向对应页；首层路由参数保留 `#comments` 锚点可选

- Baidu/Bing 额外建议
  - 站点验证：`baidu-site-verification`、`msvalidate.01`
  - 提交：自动推送/主动提交 sitemap；中文断句友好描述；避免全站 noarchive。

- 示例 JSON-LD（文章详情）

```json
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "文章标题",
  "datePublished": "2025-10-31T08:00:00+08:00",
  "dateModified": "2025-10-31T08:00:00+08:00",
  "inLanguage": "zh-CN",
  "author": {"@type": "Person", "name": "作者名"},
  "image": ["https://example.com/cover.jpg"],
  "keywords": ["Laravel","多语言","博客"],
  "articleSection": "分类名称",
  "mainEntityOfPage": {"@type": "WebPage", "@id": "https://example.com/zh/p/slug"}
}
```

实现要点（Blade 与控制器）
- 控制器为每个页面组装：`seo.title`、`seo.description`、`seo.canonical`、`seo.hreflang[]`、`seo.meta`、`seo.jsonld[]`。
- 布局 `layouts/main.blade.php` 统一渲染 `<head>` SEO 标签；页面可通过 `@section('seo')` 追加。
- 多语言互链：基于 JSON 多语言字段与后台 `lang` 配置生成 hreflang。

---

## 附录B：博客后台设计方案（LPadmin）

- 菜单结构（`Rule` 权限建议）
  - 博客管理
    - 文章管理（列表/创建/编辑/删除/发布/下线）
    - 分类管理（层级/排序/可见）
    - 标签管理（增删改查）
    - 评论管理（审核/删除/屏蔽/关键词）
    - 多语言翻译（文章/分类/标签翻译维护）
    - SEO 与站点设置（站点名、描述、favicon、OG、站点验证）
    - 搜索与索引（站内搜索配置、sitemap 生成）

- 角色与权限建议
  - `blog_admin`：全部权限
  - `blog_editor`：文章/分类/标签、翻译编辑；不能改站点设置
  - `blog_reviewer`：评论审核/屏蔽
  - 每个菜单/操作拆分到 `Rule`，视图用 `@lpadmin_can` 控制

- 多语言编辑方式
  - 采用 Tab 方式分语言编辑，参照 `lpadmin/config/system/settings` 页面交互
  - 表单字段命名：`field_i18n[lang]`；后端保存为 JSON
- 数据维护流程
  - 文章：创建主记录 → 在多语言 Tab 中维护标题/摘要/内容/slug/SEO
  - 分类/标签：在多语言 Tab 中维护名称/slug/描述；slug 按语言维度校验唯一（应用层）
  - 审核：评论默认待审（status=pending），通过后展示；支持批量审核/屏蔽

- SEO 配置与发布
  - 全局：站点名、默认描述、OG 配置、站点验证（Google/Bing/Baidu）、sitemap 任务
  - 文章级：title/description/slug/og-image/keywords 按语言维护
  - 列表/分类/标签：可维护页头描述与封面，用于 OG/Twitter
  - 发布动作：触发缓存清理与 sitemap 增量更新

- 缓存与任务
  - 缓存：热门列表、分类/标签云、详情片段；按语言区分键
  - 队列任务：sitemap 生成、预热热门页、批量静态化（可选）
  - 清理：内容变更后调用集中清理（菜单/页面片段/列表）

---

## 十二、测试规范

- 单元/功能测试：使用 PHPUnit（`vendor/bin/phpunit`）
- 组件级脚本：参考 `tests/SystemLogComponentTest.php` 风格（自举应用、显式断言与输出）
- 最小可复现：每个测试用例负责自清理（见示例 `cleanup()`）

---

## 十三、Git 工作流与提交规范

- 分支：
  - `main`: 稳定发布分支
  - `develop`: 日常集成分支
  - `feature/*`: 功能分支
  - `hotfix/*`: 线上修复
- 提交信息（建议 Conventional Commits）：
  - `feat: 增加角色批量删除接口`
  - `fix: 修复菜单树子节点展开状态`
  - `docs: 补充安装说明`
  - `test: 补充 SystemLog 回滚用例`
  - `refactor|perf|chore|build|ci` 等
- PR 规范：
  - 关联 Issue、说明动机与方案、列出影响面、附带测试与截图

---

## 十四、代码评审检查清单

- 业务：需求覆盖完整、边界情况处理充分
- 代码：遵循 PSR-12，早返回，方法短小且命名语义化
- 安全：鉴权、权限校验、输入验证与输出编码
- 性能：N+1 查询避免、缓存命中率、批量操作
- 可测试性：新增或更新了必要测试与断言
- 文档：更新相关文档与变更说明

---

## 十五、常用命令

```bash
# 代码风格
vendor/bin/pint

# 数据库迁移与填充
php artisan migrate
php artisan migrate --seed

# 测试
vendor/bin/phpunit

# 资源构建
npm run dev
npm run build
```

---

## 十六、约定与最佳实践摘录

- 新增后端接口时：
  - 路由位于 `routes/lpadmin.php`；受保护路由需挂 `lpadmin.auth` 与必要中间件
  - 控制器仅做参数校验与调度，业务沉到 Service
  - 权限控制需在菜单/权限规则（`Rule`）中登记并在视图使用指令控制
- 变更菜单/权限：调用 `MenuCacheService::handleMenuChanged()` 清理缓存
- 返回时间字段：统一格式化（中间件或 `TimeFormattable`）
- 公共函数仅保留高复用、无副作用的工具能力，放在 `app/Helpers` 并经 `composer dump-autoload`

---

如无特殊说明，本规范优先级高于团队个人习惯；若与线上已有实现冲突，以本规范为准并发起修正 PR。


