# 定时任务配置说明

## 概述

系统支持通过 Laravel 定时任务自动生成文章。当后台开启"自动生成"和"自动发布"后，系统会在指定时间自动生成并发布文章。

## 配置步骤

### 1. 后台配置

访问 `lpadmin/blog/deepseek/config` 页面，配置以下选项：

- ✅ **开启自动生成**：开启此选项后，定时任务才会执行
- ✅ **自动发布**：开启后，生成的文章会自动发布（状态为 `published`），否则保存为草稿（状态为 `draft`）
- **最少生成条数**：每次生成文章的最少数量（默认：1）
- **最多生成条数**：每次生成文章的最多数量（默认：3）
- **DeepSeek API Key**：必须配置，否则无法生成文章

### 2. 配置 Cron Job（Linux/Unix）

#### 方法一：使用 crontab

编辑 crontab：
```bash
crontab -e
```

添加以下行（将 `/path-to-your-project` 替换为实际项目路径）：
```bash
* * * * * cd /path-to-your-project && php artisan schedule:run >> /dev/null 2>&1
```

#### 方法二：使用系统 crontab

编辑系统 crontab：
```bash
sudo crontab -e
```

添加任务（注意：需要指定 PHP 和 artisan 的完整路径）：
```bash
* * * * * cd /path-to-your-project && /usr/bin/php artisan schedule:run >> /dev/null 2>&1
```

### 3. 配置 Windows 任务计划程序

1. 打开"任务计划程序"（Task Scheduler）
2. 点击"创建基本任务"
3. 设置任务名称：`Laravel Schedule`
4. 触发器：选择"每天"或"按需"
5. 操作：选择"启动程序"
6. 程序或脚本：找到 `php.exe` 的完整路径（例如：`C:\phpstudy_pro\Extensions\php\php8.2.9nts\php.exe`）
7. 添加参数：`artisan schedule:run`
8. 起始于：项目根目录（例如：`D:\phpstudy_pro\WWW\blog\blog`）
9. 完成创建

### 4. 验证配置

#### 测试定时任务命令

手动执行一次生成命令：
```bash
php artisan articles:generate --count=1
```

如果命令执行成功，说明配置正确。

#### 查看日志

定时任务执行日志保存在：
```
storage/logs/articles-generate.log
```

查看日志：
```bash
tail -f storage/logs/articles-generate.log
```

#### 查看 Laravel 日志

系统日志：
```
storage/logs/laravel.log
```

## 定时任务配置

默认配置在 `app/Console/Kernel.php` 中：

```php
// DeepSeek 自动生成文章任务（每天凌晨 2 点执行）
$schedule->command('articles:generate')
         ->dailyAt('02:00')
         ->withoutOverlapping()
         ->appendOutputTo(storage_path('logs/articles-generate.log'));
```

### 修改执行时间

可以修改 `dailyAt('02:00')` 为其他时间，例如：
- `->hourly()` - 每小时执行
- `->daily()` - 每天午夜执行
- `->dailyAt('14:00')` - 每天下午 2 点执行
- `->twiceDaily(1, 13)` - 每天 1 点和 13 点执行
- `->weekly()` - 每周执行

## 常见问题

### 1. 定时任务没有执行

**检查清单：**
- ✅ Cron Job 是否配置正确
- ✅ 后台"开启自动生成"是否开启
- ✅ DeepSeek API Key 是否配置
- ✅ 查看日志是否有错误信息

**测试命令：**
```bash
# 手动执行一次，查看是否有错误
php artisan articles:generate --count=1

# 查看 Laravel 调度器状态
php artisan schedule:list
```

### 2. 文章生成但未发布

检查后台"自动发布"选项是否开启。如果未开启，文章会保存为草稿状态。

### 3. Windows 系统任务不执行

**可能原因：**
- PHP 路径不正确
- 项目路径不正确
- 权限问题

**解决方法：**
- 使用完整路径
- 检查任务计划程序的"历史记录"查看错误信息
- 以管理员身份运行任务计划程序

### 4. 查看定时任务执行状态

**Linux/Unix：**
```bash
# 查看 cron 日志
grep CRON /var/log/syslog

# 查看 Laravel 调度器日志
tail -f storage/logs/articles-generate.log
```

**Windows：**
- 打开任务计划程序
- 查看任务的"历史记录"选项卡

## 手动触发生成

如果需要手动触发文章生成，可以使用以下命令：

```bash
# 生成 1 篇文章
php artisan articles:generate --count=1

# 生成 5 篇文章
php artisan articles:generate --count=5

# 指定关键词生成
php artisan articles:generate --count=1 --keyword="Laravel"

# 指定分类生成
php artisan articles:generate --count=1 --category=1
```

## 注意事项

1. **API 配额限制**：注意 DeepSeek API 的调用频率和配额限制
2. **执行时间**：生成文章可能需要较长时间，建议在低峰期执行
3. **数据库连接**：确保数据库服务正常运行
4. **日志清理**：定期清理日志文件，避免占用过多磁盘空间

## 相关文件

- 定时任务配置：`app/Console/Kernel.php`
- 生成命令：`app/Console/Commands/GenerateArticlesCommand.php`
- 生成服务：`app/Services/Blog/ArticleGeneratorService.php`
- 执行日志：`storage/logs/articles-generate.log`

